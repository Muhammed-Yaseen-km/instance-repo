name: Deploy to Inference Engine

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    # Runs directly on Salam's GPU machine (self-hosted runner)
    runs-on: [self-hosted, gpu]

    steps:
      - name: Pull latest code
        working-directory: ~/inference_engine
        run: |
          echo "Pulling latest changes..."
          git fetch origin main
          git reset --hard origin/main
          echo "Code updated!"

      - name: Restart services
        working-directory: ~/inference_engine
        run: |
          echo "Restarting Docker services..."
          docker compose down
          docker compose up -d
          echo "Services restarted!"

      - name: Verify deployment
        working-directory: ~/inference_engine
        run: |
          echo "Waiting for services to start..."
          sleep 15

          echo "Checking container status..."
          docker compose ps

          echo "Checking API health..."
          curl -s --max-time 10 http://localhost:8000/api/v1/health || echo "Health check pending..."

          echo ""
          echo "=========================================="
          echo "  DEPLOYMENT COMPLETE!"
          echo "=========================================="
